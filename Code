import os
import time
import csv
import spotipy
import discord
from discord.ext import tasks

# Secrets file for Spotify API credentials
with open("secrets.txt", "r") as f:
    os.environ["SPOTIPY_CLIENT_ID"] = f.readline().split("=")[1].strip()
    os.environ["SPOTIPY_CLIENT_SECRET"] = f.readline().split("=")[1].strip()

os.environ["SPOTIPY_REDIRECT_URI"] = "http://127.0.0.1:9090"

# Spotify setup
spotify = spotipy.Spotify(auth_manager=spotipy.oauth2.SpotifyOAuth(scope="user-read-playback-state"))
current_item_id = ""

# Discord setup
DISCORD_TOKEN = "your-discord-bot-token"
CHANNEL_ID = 123456789012345678  # Replace with your Discord channel ID

intents = discord.Intents.default()
intents.messages = True
client = discord.Client(intents=intents)


@client.event
async def on_ready():
    print(f"Logged in as {client.user}")
    check_spotify.start()


@tasks.loop(seconds=10)  # Check every 10 seconds
async def check_spotify():
    global current_item_id

    playback = spotify.current_playback()

    # Spotify not playing or paused
    if not playback or not playback["is_playing"]:
        return

    # Song hasn't changed
    if current_item_id == playback["item"]["id"]:
        return

    current_item_id = playback["item"]["id"]

    # Gather playback data
    song_name = playback["item"]["name"]
    artist_name = ", ".join(artist["name"] for artist in playback["item"]["artists"])
    album_name = playback["item"]["album"]["name"]
    album_image = playback["item"]["album"]["images"][0]["url"]
    track_url = playback["item"]["external_urls"]["spotify"]

    # Send message to Discord
    channel = client.get_channel(CHANNEL_ID)
    embed = discord.Embed(title=song_name, description=f"By {artist_name}\nAlbum: {album_name}", url=track_url)
    embed.set_thumbnail(url=album_image)
    await channel.send(embed=embed)


client.run(DISCORD_TOKEN)
